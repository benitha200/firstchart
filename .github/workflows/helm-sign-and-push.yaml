name: Sign and Push Helm Chart

on:
  push:
    paths:
      - 'charts/**'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Set Up Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: üîê Import GPG Key
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg  # üîê Fix permissions

          echo "$GPG_PRIVATE_KEY" | gpg --batch --import

          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf  # ‚úÖ Removed `use-agent`
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf

          chmod 600 ~/.gnupg/*

          gpg --batch --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --list-secret-keys
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: üì¶ Package and Sign Helm Chart
        run: |
          helm dependency update .
          ls firstchart/firstchart
          helm package firstchart/firstchart \
            --sign \
            --key "$GPG_KEY_ID" \
            --keyring ~/.gnupg/pubring.kbx \
            --passphrase "$GPG_PASSPHRASE"
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: üîë Verify Chart Signature (optional for testing)
        run: |
          helm verify mychart-*.tgz || echo "‚ùó Signature verification failed"

      - name: üì§ Push Chart to OCI Registry
        run: |
          helm registry login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
          helm push mychart-*.tgz oci://ghcr.io/benitha200

